(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{127:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=r.a.createContext({}),b=function(e){var t=r.a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},u=function(e){var t=b(e.components);return r.a.createElement(i.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,o=e.parentName,i=s(e,["components","mdxType","originalType","parentName"]),u=b(n),d=a,m=u["".concat(o,".").concat(d)]||u[d]||p[d]||l;return n?r.a.createElement(m,c(c({ref:t},i),{},{components:n})):r.a.createElement(m,c({ref:t},i))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,o=new Array(l);o[0]=d;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,o[1]=c;for(var i=2;i<l;i++)o[i]=n[i];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},181:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/ide_debug_configutation-8526080b8539923c9ccd9d8e3e2738ca.png"},182:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/ide_debug_action-03ad1d55c293740efc5e4f3773c2e809.png"},61:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return b}));var a=n(2),r=n(6),l=(n(0),n(127)),o={id:"1_developer_guide",title:"Developer guide",sidebar_label:"Developer guide"},c={unversionedId:"8_contributing/1_developer_guide",id:"8_contributing/1_developer_guide",isDocsHomePage:!1,title:"Developer guide",description:"CircleCI build pipeline",source:"@site/docs/8_contributing/1_developer_guide.md",slug:"/8_contributing/1_developer_guide",permalink:"/casskop/docs/8_contributing/1_developer_guide",editUrl:"https://github.com/Orange-OpenSource/casskop/edit/master/website/docs/8_contributing/1_developer_guide.md",version:"current",sidebar_label:"Developer guide",sidebar:"docs",previous:{title:"GKE Issues",permalink:"/casskop/docs/7_troubleshooting/2_gke_issues"},next:{title:"Release guide",permalink:"/casskop/docs/8_contributing/2_release_guide"}},s=[{value:"CircleCI build pipeline",id:"circleci-build-pipeline",children:[{value:"CircleCI config validation hook",id:"circleci-config-validation-hook",children:[]},{value:"CircleCI on PR",id:"circleci-on-pr",children:[]}]},{value:"Operator SDK",id:"operator-sdk",children:[{value:"Prerequisites",id:"prerequisites",children:[]},{value:"Install the Operator SDK CLI",id:"install-the-operator-sdk-cli",children:[]},{value:"Initial setup",id:"initial-setup",children:[]},{value:"Local kubernetes setup",id:"local-kubernetes-setup",children:[]},{value:"Build CassKop",id:"build-casskop",children:[]},{value:"Run CassKop",id:"run-casskop",children:[]},{value:"Run unit-tests",id:"run-unit-tests",children:[]},{value:"Run e2e end to end tests",id:"run-e2e-end-to-end-tests",children:[]},{value:"Run kuttl tests",id:"run-kuttl-tests",children:[]},{value:"Debug CassKop in remote in a Kubernetes cluster",id:"debug-casskop-in-remote-in-a-kubernetes-cluster",children:[]},{value:"Build Multi-CassKop",id:"build-multi-casskop",children:[]},{value:"Run Multi-CassKop",id:"run-multi-casskop",children:[]}]},{value:"How this repository was initially build",id:"how-this-repository-was-initially-build",children:[{value:"Boilerplate CassKop",id:"boilerplate-casskop",children:[]},{value:"Useful Infos for developers",id:"useful-infos-for-developers",children:[]}]}],i={rightToc:s};function b(e){var t=e.components,o=Object(r.a)(e,["components"]);return Object(l.b)("wrapper",Object(a.a)({},i,o,{components:t,mdxType:"MDXLayout"}),Object(l.b)("h2",{id:"circleci-build-pipeline"},"CircleCI build pipeline"),Object(l.b)("p",null,"We use CircleCI to build and test the operator code on each commit."),Object(l.b)("h3",{id:"circleci-config-validation-hook"},"CircleCI config validation hook"),Object(l.b)("p",null,"To discover errors in the CircleCI earlier, we can uses the ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://circleci.com/docs/2.0/local-cli/"}),"CircleCI cli"),"\nto validate the config file on pre-commit git hook."),Object(l.b)("p",null,"Fisrt you must install the cli, then to install the hook, runs:<"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-console"}),"cp tools/pre-commit .git/hooks/pre-commit\n")),Object(l.b)("p",null,"The Pipeline uses some envirenment variables that you need to set-up if you want your fork to build"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"DOCKER_REPO_BASE -- name of your docker base reposirory (ex: orangeopensource)"),Object(l.b)("li",{parentName:"ul"},"DOCKERHUB_PASSWORD"),Object(l.b)("li",{parentName:"ul"},"DOCKERHUB_USER- SONAR_PROJECT"),Object(l.b)("li",{parentName:"ul"},"SONAR_TOKEN")),Object(l.b)("p",null,"If not set in CircleCI environment, according steps will be ignored."),Object(l.b)("h3",{id:"circleci-on-pr"},"CircleCI on PR"),Object(l.b)("p",null,"When you submit a Pull Request, then CircleCI will trigger build pipeline.\nSince this is pushed from a fork, for security reason the pipeline won't have access to the environment secrets,\nand not all steps could be executed."),Object(l.b)("h2",{id:"operator-sdk"},"Operator SDK"),Object(l.b)("h3",{id:"prerequisites"},"Prerequisites"),Object(l.b)("p",null,"Casskop has been validated with :"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://golang.github.io/dep/"}),"dep")," version v0.5.1+."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://golang.org"}),"go")," version v1.13+."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://www.docker.com"}),"docker")," version 18.09+."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://kubernetes.io/fr/docs/tasks/tools/install-kubectl/"}),"kubectl")," version v1.13.3+."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://helm.sh/"}),"Helm")," version v.3."),Object(l.b)("li",{parentName:"ul"},"Fork from ",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/operator-framework/operator-sdk"}),"Operator sdk")," version v0.18.0 : ",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/erdrix/operator-sdk/tree/v0.18.0-forked-pr317"}),"Operator sdk - forked"))),Object(l.b)("h3",{id:"install-the-operator-sdk-cli"},"Install the Operator SDK CLI"),Object(l.b)("p",null,"First, checkout and install the operator-sdk CLI:"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"$ mkdir -p $GOPATH/src/github.com/operator-framework/\n$ cd $GOPATH/src/github.com/operator-framework/\ngit clone -b v0.18.0-forked-pr317 --single-branch git@github.com:erdrix/operator-sdk.git\n$ make tidy\n$ make install\n")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Note :")," Use fork from operator-sdk, waiting for ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/kubernetes-sigs/controller-tools/pull/317/files#diff-8963ad7c8dcbe3931bc61c3e2954ccf2R300-R301"}),"PR #317")," to be merged."),Object(l.b)("h3",{id:"initial-setup"},"Initial setup"),Object(l.b)("p",null,"Checkout the project."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"$ git clone https://github.com/Orange-OpenSource/casskop.git\n$ cd casskop\n")),Object(l.b)("h3",{id:"local-kubernetes-setup"},"Local kubernetes setup"),Object(l.b)("p",null,"We use ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://kind.sigs.k8s.io"}),"kind")," in order to run a local kubernetes cluster with the version we chose. We think it deserves some words as it's pretty useful and simple to use to test one version or another"),Object(l.b)("h4",{id:"install"},"Install"),Object(l.b)("p",null,"The following requires kubens to be present. On MacOs it can be installed using brew :"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"brew install kubectx\n")),Object(l.b)("p",null,"The installation of kind is then done with (outside of the cassandra operator folder if you want it to run fast) :"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),'$ GO111MODULE="on" go get sigs.k8s.io/kind@v0.5.1\n')),Object(l.b)("h4",{id:"setup"},"Setup"),Object(l.b)("p",null,"The following actions should be run only to create a new kubernetes cluster."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"$ samples/kind/create-kind-cluster.sh\n")),Object(l.b)("p",null,"or if you want to enable network policies"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"$ samples/kind/create-kind-cluster-network-policies.sh\n")),Object(l.b)("p",null,"It creates namespace cassandra-e2e by default. If a different namespace is needed it can be specified on the setup-requirements call"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"$ samples/kind/setup-requirements.sh other-namespace\n")),Object(l.b)("p",null,"To interact with the cluster you then need to use the generated kubeconfig file :"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"$ export KUBECONFIG=$(kind get kubeconfig-path --name=kind)\n")),Object(l.b)("p",null,"Before using that newly created cluster, it's better to wait for all pods to be running by continously checking their status :"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"$ kubectl get pod --all-namespaces -w\n")),Object(l.b)("h4",{id:"pauseunpause-the-cluster"},"Pause/Unpause the cluster"),Object(l.b)("p",null,"In order to kinda freeze the cluster because you need to do something else on your laptop, you can use those two aliases. Just put them in your ~/.bashrc or ~/.zshrc :"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"alias kpause='kind get nodes|xargs docker pause'\nalias kunpause='kind get nodes|xargs docker unpause'\n")),Object(l.b)("h4",{id:"delete-cluster"},"Delete cluster"),Object(l.b)("p",null,"The simple command ",Object(l.b)("inlineCode",{parentName:"p"},"kind delete cluster")," takes care of it."),Object(l.b)("h3",{id:"build-casskop"},"Build CassKop"),Object(l.b)("h4",{id:"using-your-local-environment"},"Using your local environment"),Object(l.b)("p",null,"If you prefer working directly with your local go environment you can simply uses :"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"make get-deps\nmake build\n")),Object(l.b)("blockquote",null,Object(l.b)("p",{parentName:"blockquote"},"You can check on the Gitlab Pipeline to see how the Project is build and test for each push")),Object(l.b)("h4",{id:"or-using-the-provided-cross-platform-build-environment"},"Or Using the provided cross platform build environment"),Object(l.b)("p",null,"Build the docker image which will be used to build CassKop docker image"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"make build-ci-image\n")),Object(l.b)("blockquote",null,Object(l.b)("p",{parentName:"blockquote"},"If you want to change the operator-sdk version change the ",Object(l.b)("strong",{parentName:"p"},"OPERATOR_SDK_VERSION")," in the Makefile.")),Object(l.b)("p",null,"Then build CassKop (code & image)"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"make docker-get-deps\nmake docker-build\n")),Object(l.b)("h3",{id:"run-casskop"},"Run CassKop"),Object(l.b)("p",null,"We can quickly run CassKop in development mode (on your local host), then it will use your kubectl configuration file to connect to your kubernetes cluster."),Object(l.b)("p",null,"There are several ways to execute your operator :"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"Using your IDE directly"),Object(l.b)("li",{parentName:"ul"},"Executing directly the Go binary"),Object(l.b)("li",{parentName:"ul"},"deploying using the Helm charts")),Object(l.b)("p",null,"If you want to configure your development IDE, you need to give it environment variables so that it will uses to connect to kubernetes."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"KUBECONFIG=<path/to/your/kubeconfig>\nWATCH_NAMESPACE=<namespace_to_watch>\nPOD_NAME=<name for operator pod>\nLOG_LEVEL=Debug\nOPERATOR_NAME=ide\n")),Object(l.b)("h4",{id:"run-the-operator-locally-with-the-go-binary"},"Run the Operator Locally with the Go Binary"),Object(l.b)("p",null,"This method can be used to run the operator locally outside of the cluster. This method may be preferred during development as it facilitates faster deployment and testing."),Object(l.b)("p",null,"Set the name of the operator in an environment variable"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ export OPERATOR_NAME=cassandra-operator\n")),Object(l.b)("p",null,"Deploy the CRD"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ kubectl apply -f deploy/crds/db.orange.com_cassandraclusters_crd.yaml\n")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ make run\n")),Object(l.b)("p",null,"This will run the operator in the ",Object(l.b)("inlineCode",{parentName:"p"},"default")," namespace using the default Kubernetes config file at ",Object(l.b)("inlineCode",{parentName:"p"},"$HOME/.kube/config"),"."),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Note:")," JMX operations cannot be executed on Cassandra nodes when running the operator locally. This is because the operator makes JMX calls over HTTP using jolokia and when running locally the operator is on a different network than the Cassandra cluster."),Object(l.b)("h4",{id:"deploy-using-the-helm-charts"},"Deploy using the Helm Charts"),Object(l.b)("p",null,"This section provides an instructions for running the operator Helm charts with an image that is built from the local branch."),Object(l.b)("p",null,"Build the image from the current branch."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ export DOCKER_REPO_BASE=<your-docker-repo>\n$ make docker-build\n")),Object(l.b)("p",null,"Push the image to docker hub (or to whichever repo you want to use)"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ make push\n")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Note:")," In this example we are pushing to docker hub."),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Note:")," The image tag is a combination of the version as defined in ",Object(l.b)("inlineCode",{parentName:"p"},"verion/version.go")," and the branch name."),Object(l.b)("p",null,"Install the Helm chart."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ helm install ./helm/cassandra-operator \\\n    --set-string image.repository=orangeopensource/casskop,image.tag=0.4.0-local-dev-helm \\\n    --name local-dev-helm\n")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Note:")," The ",Object(l.b)("inlineCode",{parentName:"p"},"image.repository")," and ",Object(l.b)("inlineCode",{parentName:"p"},"image.tag")," template variables have to match the names from the image that we pushed in the previous step."),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Note:")," We set the chart name to the branch, but it can be anything."),Object(l.b)("p",null,"Lastly, verify that the operator is running."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ kubectl get pods\nNAME                                                READY   STATUS    RESTARTS   AGE\nlocal-dev-helm-cassandra-operator-8946b89dc-4cfs9   1/1     Running   0          7m45s\n")),Object(l.b)("h3",{id:"run-unit-tests"},"Run unit-tests"),Object(l.b)("p",null,"You can run Unit-test for CassKop"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"make unit-test\n")),Object(l.b)("h3",{id:"run-e2e-end-to-end-tests"},"Run e2e end to end tests"),Object(l.b)("p",null,"CassKop also have several end-to-end tests that can be run using makefile."),Object(l.b)("p",null,"You need to create the namespace ",Object(l.b)("inlineCode",{parentName:"p"},"cassandra-e2e")," before running the tests."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"kubectl create namespace cassandra-e2e\n")),Object(l.b)("p",null,"to launch different tests in parallel in different temporary namespaces"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"make e2e\n")),Object(l.b)("p",null,"or sequentially in the namespace ",Object(l.b)("inlineCode",{parentName:"p"},"cassandra-e2e")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"make e2e-test-fix\n")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Note"),": ",Object(l.b)("inlineCode",{parentName:"p"},"make e2e")," executes all tests in different, temporary namespaces in parallel. Your k8s cluster will need a lot of resources to handle the many Cassandra nodes that launch in parallel. "),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Note"),": ",Object(l.b)("inlineCode",{parentName:"p"},"make e2e-test-fix")," executes all tests serially in the ",Object(l.b)("inlineCode",{parentName:"p"},"cassandra-e2e")," namespace and as such does not require as many k8s resources as ",Object(l.b)("inlineCode",{parentName:"p"},"make e2e")," does, but overall execution will be slower."),Object(l.b)("p",null,"You can choose to run only 1 test using the args ex:"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"make e2e-test-fix-arg ClusterScaleDown\n")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Tip"),": When debugging test failures, you can run ",Object(l.b)("inlineCode",{parentName:"p"},"kubectl get events --all-namespaces")," which produce output like:"),Object(l.b)("p",null,Object(l.b)("inlineCode",{parentName:"p"},"cassandracluster-group-clusterscaledown-1561640024   0s    Warning   FailedScheduling   Pod   0/4 nodes are available: 1 node(s) had taints that the pod didn't tolerate, 3 Insufficient cpu.")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Tip"),": When tests fail, there may be resources that need to be cleaned up. Run ",Object(l.b)("inlineCode",{parentName:"p"},"tools/e2e_test_cleanup.sh")," to delete resources left over from tests."),Object(l.b)("h3",{id:"run-kuttl-tests"},"Run kuttl tests"),Object(l.b)("p",null,"This requires ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://kuttl.dev/docs/cli.html#setup-the-kuttl-kubectl-plugin"}),"kuttl cli")," to be installed on your machine"),Object(l.b)("p",null,"You first need to have a Kubernetes cluster set up with kubectl."),Object(l.b)("p",null,"Then to run all tests you can simply type :"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"kubectl kuttl test --config ./test/e2e/kuttl/kuttl-test.yaml ./test/e2e/kuttl/\n")),Object(l.b)("p",null,"This will run all testcases in the ",Object(l.b)("inlineCode",{parentName:"p"},"/test/e2e/kuttl/")," directory in parallel on different generated namespaces (with Casskop automatically installed on each)."),Object(l.b)("blockquote",null,Object(l.b)("p",{parentName:"blockquote"},"If you installed only the binary of kuttl, you can omit the ",Object(l.b)("inlineCode",{parentName:"p"},"kubectl")," at the beginning")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Tip"),": You can specify a single test case to run by adding ",Object(l.b)("inlineCode",{parentName:"p"},"--test TestCase")," where ",Object(l.b)("inlineCode",{parentName:"p"},"TestCase")," is the name of one of the directories in ",Object(l.b)("inlineCode",{parentName:"p"},"/test/e2e/kuttl/*here*")," (like ",Object(l.b)("inlineCode",{parentName:"p"},"ScaleUpAndDown")," for example)"),Object(l.b)("h3",{id:"debug-casskop-in-remote-in-a-kubernetes-cluster"},"Debug CassKop in remote in a Kubernetes cluster"),Object(l.b)("p",null,"CassKop makes some specific calls to the Jolokia API of the CassandraNodes it deploys inside the kubernetes\ncluster. Because of this, it is not possible to fully debug CassKop when launch outside the kubernetes cluster (in\nyour local IDE)."),Object(l.b)("p",null,"It is possible to use external solutions such as KubeSquash or Telepresence."),Object(l.b)("p",null,"Telepresence launch a bi-directional tunnel between your dev environment and an existing operator pod in the cluster\nwhich it will ",Object(l.b)("strong",{parentName:"p"},"swap")),Object(l.b)("p",null,"To launch the telepresence utility you can launch"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"make telepresence\n")),Object(l.b)("blockquote",null,Object(l.b)("p",{parentName:"blockquote"},"You need to install it before see : ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.telepresence.io/"}),"https://www.telepresence.io/"))),Object(l.b)("p",null,"If your cluster don't have Internet access, you can change the telepresence image to use to one your cluster have access\nexemple:"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"TELEPRESENCE_REGISTRY=you-private-registry/datawire  make debug-telepresence-with-alias\n")),Object(l.b)("h4",{id:"configure-the-ide"},"Configure the IDE"),Object(l.b)("p",null,"Now we just need to configure the IDE :"),Object(l.b)("p",null,Object(l.b)("img",{src:n(181).default})),Object(l.b)("p",null,"and let's the magic happened"),Object(l.b)("p",null,Object(l.b)("img",{src:n(182).default})),Object(l.b)("h3",{id:"build-multi-casskop"},"Build Multi-CassKop"),Object(l.b)("h4",{id:"using-your-docker-environment"},"Using your docker environment"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"cd $(git rev-parse --show-toplevel)/multi-casskop\nmake docker-build\n")),Object(l.b)("h3",{id:"run-multi-casskop"},"Run Multi-CassKop"),Object(l.b)("p",null,"We can quickly setup a k3d cluster with casskop and multi-casskop to test a PR on multi-casskop. "),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"[Build your multi-casskop docker image]","(#### Using your docker environment) which should print")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),'echo "Generate zzz-deepcopy objects"\nGenerate zzz-deepcopy objects\n...\nSuccessfully built bf57e90615bb\nSuccessfully tagged orangeopensource/multi-casskop:0.5.6-my-pr\n')),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"Create a k3 cluster with 2 namespaces and install casskop")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"k3d cluster create multi-casskop-qa\ncd $(git rev-parse --show-toplevel)\nkubectl  apply -f deploy/crds/\nkubectl  create namespace cluster1\nkubectl  create namespace cluster2\nhelm install casskop -n cluster1 orange-incubator/cassandra-operator --set debug.enabled=true\nhelm install casskop -n cluster2 orange-incubator/cassandra-operator --set debug.enabled=true\nkubemcsa export --context=k3d-multi-casskop-qa cassandra-operator --as k8s-cluster2 -n cluster1 | k apply -n cluster1 -f -\n")),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"Update generated secret to use ",Object(l.b)("inlineCode",{parentName:"li"},"server: https://kubernetes.default.svc/")," in its config (We won't need that method\nanymore and will be able to create 2 different clusters when ",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/rancher/k3d/issues/101"}),"https://github.com/rancher/k3d/issues/101")," is solved)")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"kubectl  get secrets -n cluster1 k8s-cluster2 -o json|jq -r '.data.config'|base64 -d|pbcopy\n# set server to https://kubernetes.default.svc in the output, then copy it in the clipboard and run\npbpaste|base64 -w10000|pbcopy\n# You now have to edit the secret and replace config's value by what you have in your clipboard\n")),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"load the docker image you built in the first step into your k3d cluster")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"k3d image import orangeopensource/multi-casskop:0.5.6-my-pr -c multi-casskop-qa\nINFO[0000] Loading images into 'multi-casskop-qa'\nINFO[0000] Starting k3d-tools node...\nINFO[0000] Saving 1 image(s) from runtime...\nINFO[0004] Importing images into nodes...\nINFO[0004] Importing images from tarball '/k3d/images/k3d-multi-casskop-qa-images-20200929124019.tar' into node 'k3d-multi-casskop-qa-server-0'...\nINFO[0006] Removing the tarball(s) from image volume...\nINFO[0007] Removing k3d-tools node...\nINFO[0008] Deleted k3d-multi-casskop-qa-tools\nINFO[0008] Successfully imported image(s)\nINFO[0008] DONE\n")),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"Install multi-casskop using the image you just imported")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"helm install multi-casskop orange-incubator/multi-casskop --set k8s.local=k3d-multi-casskop-qa \\\n    --set k8s.remote={k8s-cluster2} --set image.tag=0.5.6-my-pr --set debug.enabled=true -n cluster1 \\\n    --set image.pullPolicy=IfNotPresent\n")),Object(l.b)("h2",{id:"how-this-repository-was-initially-build"},"How this repository was initially build"),Object(l.b)("h3",{id:"boilerplate-casskop"},"Boilerplate CassKop"),Object(l.b)("p",null,"We used the SDK to create the repository layout. This command is for memory ;) (or for applying sdk upgrades)"),Object(l.b)("blockquote",null,Object(l.b)("p",{parentName:"blockquote"},"You need to have first install the SDK.")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"#old version\n operator-sdk new casskop --api-version=db.orange.com/v1alpha1 --kind=CassandraCluster\n#new version\noperator-sdk new casskop --dep-manager=modules --repo=github.com.Orange-OpenSource/casskop --type=go\n")),Object(l.b)("p",null,"Then you want to add managers:"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"# Add a new API for the custom resource CassandraCluster\n$ operator-sdk add api --api-version=db.orange.com/v1alpha1 --kind=CassandraCluster\n\n# Add a new controller that watches for CassandraCluster\n$ operator-sdk add controller --api-version=db.orange.com/v1alpha1 --kind=CassandraCluster\n")),Object(l.b)("h3",{id:"useful-infos-for-developers"},"Useful Infos for developers"),Object(l.b)("h4",{id:"parsing-yaml-from-string"},"Parsing Yaml from String"),Object(l.b)("p",null,"For parsing Yaml from string to Go Object we uses this library : ",Object(l.b)("inlineCode",{parentName:"p"},"github.com/ghodss/yaml")," because with the official one\nnot all fields of the yaml where correctly populated. I don't know why.."))}b.isMDXComponent=!0}}]);