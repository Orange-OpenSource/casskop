<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70dece09e">
<link rel="search" type="application/opensearchdescription+xml" title="CassKop" href="/casskop/opensearch.xml"><title data-react-helmet="true">Operations Issues | CassKop</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Operations Issues | CassKop"><meta data-react-helmet="true" name="description" content="Operator can&#x27;t perform the Action"><meta data-react-helmet="true" property="og:description" content="Operator can&#x27;t perform the Action"><meta data-react-helmet="true" property="og:url" content="https://orange-opensource.github.io/casskop/docs/7_troubleshooting/1_operations_issues"><link data-react-helmet="true" rel="shortcut icon" href="/casskop/img/casskop.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://orange-opensource.github.io/casskop/docs/7_troubleshooting/1_operations_issues"><link rel="stylesheet" href="/casskop/styles.f2c05978.css">
<link rel="preload" href="/casskop/styles.e109d7ba.js" as="script">
<link rel="preload" href="/casskop/runtime~main.8734032c.js" as="script">
<link rel="preload" href="/casskop/main.13402a17.js" as="script">
<link rel="preload" href="/casskop/1.609d1f21.js" as="script">
<link rel="preload" href="/casskop/2.9fbf0449.js" as="script">
<link rel="preload" href="/casskop/67.98ba5add.js" as="script">
<link rel="preload" href="/casskop/70.177fd3ba.js" as="script">
<link rel="preload" href="/casskop/935f2afb.fcfa68e0.js" as="script">
<link rel="preload" href="/casskop/17896441.6be1b574.js" as="script">
<link rel="preload" href="/casskop/ac494530.39ec1365.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/casskop/"><img src="/casskop/img/casskop_alone.png" alt="CassKop Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/casskop/img/casskop_alone.png" alt="CassKop Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">CassKop</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/casskop/docs/1_concepts/1_introduction">Docs</a><a class="navbar__item navbar__link" href="/casskop/blog">Blog</a><a href="https://github.com/Orange-OpenSource/casskop" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><div class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></div></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/casskop/"><img src="/casskop/img/casskop_alone.png" alt="CassKop Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/casskop/img/casskop_alone.png" alt="CassKop Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">CassKop</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/1_concepts/1_introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/Orange-OpenSource/casskop" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Concepts</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/1_concepts/1_introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/1_concepts/2_features">Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/1_concepts/3_design_principes">Design Principes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/1_concepts/4_roadmap">Roadmap</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Setup</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/2_setup/1_getting_started">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/2_setup/2_install_plugin">Install Plugin</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/2_setup/3_multi_casskop">Multi-CassKop</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Platform Setup</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/2_setup/2_platform_setup/1_gke">Google Kubernetes Engine</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/2_setup/2_platform_setup/2_minikube">MiniKube</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced Configuration</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/1_customizable_install_with_helm">Customizable install with Helm</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/2_cassandra_cluster">Cassandra Cluster</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/3_storage">Storage</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/4_cluster_topology">Cluster topology</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/2_cassandra_configuration">Cassandra Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/5_sidecars">Sidecars</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/9_advanced_configuration">Advanced Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/10_nodes_management">Nodes Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/3_configuration_deployment/11_cassandra_cluster_status">CassandraCluster Status</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Operations</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/5_operations/0_implementation_architecture">Implementation architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/5_operations/1_cluster_operations">Cluster Operations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/5_operations/2_pods_operations">Pods Operations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/5_operations/3_multi_casskop">Multi-CassKop</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/5_operations/3_5_backup_restore">Backup and restore</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/5_operations/4_upgrade_operator">Upgrade Operator</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/5_operations/5_upgrade_bootstrap_image">Upgrade Bootstrap Image</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/5_operations/6_uninstall_casskop">Uninstall Casskop</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/6_references/1_cassandra_cluster">Cassandra cluster</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/6_references/2_topology">Topology</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/6_references/3_cassandra_cluster_status">Cassandra cluster Status</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/6_references/4_multicasskop">MultiCasskop</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/6_references/5_cassandra_backup">Cassandra backup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/6_references/6_cassandra_restore">Cassandra restore</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Troubleshooting</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/casskop/docs/7_troubleshooting/1_operations_issues">Operations Issues</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/casskop/docs/7_troubleshooting/2_gke_issues">GKE Issues</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contributing</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/8_contributing/1_developer_guide">Developer guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/8_contributing/2_release_guide">Release guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/8_contributing/3_reporting_bugs">Reporting bugs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/casskop/docs/8_contributing/4_credits">Credits</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Operations Issues</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="operator-cant-perform-the-action"></a>Operator can&#x27;t perform the Action<a class="hash-link" href="#operator-cant-perform-the-action" title="Direct link to heading">#</a></h2><p>If you ask to scale up or add a new DC, or ask for more resources, CassKop will ask Kubernetes to schedule as you
requested.
But sometimes it is not possible to achieve the change because of a lack of resources (memory/cpus) or because
constraints can&#x27;t be satisfied (Kubernetes nodes with specific labels available...)</p><p>CassKop make uses of the PodDisruptionBudget to prevent CassKop to make some change on the CassandraCluster that could
make more than 1 Cassandra node at a time. </p><p>If you have a Pod stuck in <strong>pending</strong> state, then you have at least 1 Pod in Disruption, and the PDB object will
prevent you to make changes on statefulset because that mean that you will have more than 1 Cassandra down at a time.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-console codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get poddisruptionbudgets</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME             MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo   N/A             1                 0                     12m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The Operator logs this line when there is disruption on the Cassandra cluster:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-logs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[3037] Cluster has Disruption on Pods, we wait before applying any change to statefulset  cluster=cassandra-demo dc-rack=dc1-rack1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cant-scaleup"></a>Can&#x27;t ScaleUp<a class="hash-link" href="#cant-scaleup" title="Direct link to heading">#</a></h3><p>In this example I ask a ScaleUp but it can&#x27;t perform :</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-console codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get pods</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                                                              READY   STATUS    RESTARTS   AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc1-rack1-0                                        1/1     Running   0          16h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc1-rack1-1                                        0/1     Pending   0          12m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc1-rack2-0                                        1/1     Running   0          16h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc1-rack3-0                                        1/1     Running   0          16h</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>the cassandra-demo-dc1-rack1-1 pod is Pending and can&#x27;t be scheduled.</p><p>If we looked at the pod status we will see this message :</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Warning  FailedScheduling   51s (x17 over 14m)    default-scheduler   0/6 nodes are available: 4 Insufficient cpu, 4 node(s) didn&#x27;t match node selector.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Kubernetes can&#x27;t find any Pod with sufficient cpu and matching kubernetes nodes labels we asked in the topology section.</p><p>To fix this, we can either:</p><ul><li>reduce memory/cpu limits</li><li>add more kubernetes nodes that will satisfied our requirements.</li><li>rollback the scaleUp Operation</li></ul><blockquote><p>At this point, CassKop will wait indefinitely to the case to be Fix</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rollback-scaleup-operation"></a>Rollback ScaleUp operation<a class="hash-link" href="#rollback-scaleup-operation" title="Direct link to heading">#</a></h4><p>In order to rollback the operation, we need to revert the change on the <code>nodesPerRacks</code> parameter.</p><blockquote><p>This is not sufficient</p></blockquote><p>Because CassKop is actually performing another action on the cluster (ScaleUp) we can&#x27;t scheduled a new operation to
rollback since it has not finished.
We introduced a new parameter in the CRD to allow such changes when all the pods can&#x27;t be scheduled:</p><ul><li><code>Spec.unlockNextOperation: true</code></li></ul><blockquote><p><em><strong>ðŸš© Warning</strong> This is not a regular parameter and it must be used with very good care!!.</em></p></blockquote><p>By adding this parameter in our cluster definition, CassKop will allow to trigger a new operation.</p><blockquote><p>Once CassKop has scheduled the new operation, it will reset this parameter to the default <code>false</code> value.
value. If you need more operation, you will need to reset the parameter to force another Operation.
Keep in mind that CassKop is mean to do only 1 operation at a time.</p></blockquote><p>If this is not already done, you can now rollback the scaleUp updating <code>nodesPerRacks: 1</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">WARN[3348] ScaleDown detected on a pending Pod. we don&#x27;t launch decommission  cluster=cassandra-demo pod=cassandra-demo-dc1-rack1-1 rack=dc1-rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[3350] Cluster has 1 Pod Disrupted but that may be normal as we are decommissioning  cluster=cassandra-demo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dc-rack=dc1-rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[3354] [cassandra-demo][dc1-rack1]: StatefulSet(ScaleDown): Replicas Number OK: ready[1] </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[3354] ScaleDown not yet Completed: Waiting for Pod operation to be Done  cluster=cassandra-demo rack=dc1-rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[3354] Decommission done -&gt; we delete PVC            cluster=cassandra-demo pvc=data-cassandra-demo-dc1-rack1-1 rack=dc1-rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[3354] PVC deleted                                   cluster=cassandra-demo pvc=data-cassandra-demo-dc1-rack1-1 rack=dc1-rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DEBU[3354] Waiting Rack to be running before continuing, we break ReconcileRack Without Updating Statefulset  cluster=cassandra-demo dc-rack=dc1-rack1 err=&quot;&lt;nil&gt;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[3354] ScaleDown is Done                             cluster=cassandra-demo rack=dc1-rack1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cant-add-new-rack-in-new-dc"></a>Can&#x27;t add new rack in new DC<a class="hash-link" href="#cant-add-new-rack-in-new-dc" title="Direct link to heading">#</a></h3><p>In this example, I ask to add dc called dc2</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get pods</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                                                              READY   STATUS    RESTARTS   AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc1-rack1-0                                        1/1     Running   0          17h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc1-rack2-0                                        1/1     Running   0          17h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc1-rack3-0                                        1/1     Running   0          17h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc2-rack1-0                                        1/1     Running   0          5m46s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc2-rack2-0                                        1/1     Running   0          4m20s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc2-rack3-0                                        0/1     Pending   0          2m37s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>But the last one can&#x27;t be scheduled because of insufficient cpu on k8s nodes.</p><p>We can either add the wanted resources in the k8s cluster or make a rollback.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="solution1-rollback-adding-the-dc"></a>Solution1: rollback adding the DC<a class="hash-link" href="#solution1-rollback-adding-the-dc" title="Direct link to heading">#</a></h4><p>To rollback the add of the new DC, we first need to scale down to 0 for the nodes that already have join the ring.
We need to allow disruption as we do in previous section.</p><p>then We first need to ask the dc2 to scaleDown to 0 because it has already add 2 racks, and we add the
spec.unlockNextOperation to true.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  unlockNextOperation: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: dc2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    nodesPerRacks: 0</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This will allow CassKop to make the scale down. because it will start with the first rack, it will free some space and
the last pod which was pending will be joining. then it will be decommissioned by CassKop.</p><p>we can see in CassKop logs when it deal with the rack with unscheduled pods:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">WARN[0667] Aborting Initializing..., start ScaleDown                      cluster=cassandra-demo rack=dc2-rack3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[0667] The Operator Waits 20 seconds for the action to start correctly  cluster=cassandra-demo rack=dc2-rack3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WARN[0667] ScaleDown detected on a pending Pod. we don&#x27;t launch decommission  cluster=cassandra-demo pod=cassandra-demo-dc2-rack3-0 rack=dc2-rack3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[0667] Cluster has 1 Pod Disrupted but that may be normal as we are decommissioning</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cluster=cassandra-demodc-rack=dc2-rack3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[0667] Template is different:  {...}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>It will also ScaleDown any pods that was part of the new DC.</p><blockquote><p>Once ScaleDown is done, you can delete the DC from the Spec.</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="solution2-change-the-topology-for-dc2-remove-the-3rd-unschedulable-rack"></a>Solution2: change the topology for dc2 (remove the 3rd unschedulable rack)<a class="hash-link" href="#solution2-change-the-topology-for-dc2-remove-the-3rd-unschedulable-rack" title="Direct link to heading">#</a></h4><p>we get back in the previous section before making the rolling back of adding the dc2.</p><p>If only one of the Racks can&#x27;t schedule any pods, we can change the topology to remove the Rack ONLY if there was not already
pods deployed in the Rack. If this is not the case, then you will need to process ScaleDown instead of removing rack.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        failure-domain.beta.kubernetes.io/region: europe-west1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      name: dc2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      nodesPerRacks: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      numTokens: 256</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      rack:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          failure-domain.beta.kubernetes.io/zone: europe-west1-d</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          failure-domain.beta.kubernetes.io/zone: europe-west1-c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: rack2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          failure-domain.beta.kubernetes.io/zone: europe-west1-d</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: rack3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>let&#x27;s remove the rack3 from dc2.</p><p>the operator will log :</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">WARN[0347] We asked to remove Rack dc2-rack3 with unschedulable pod  cluster=cassandra-demo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INFO[0347] [cassandra-demo]: Delete PVC[data-cassandra-demo-dc2-rack3-0] OK </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The rack3 (and its statefulset) has been removed, and the associated (empty) pvc deleted</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/Orange-OpenSource/casskop/edit/master/website/docs/7_troubleshooting/1_operations_issues.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/casskop/docs/6_references/6_cassandra_restore"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Cassandra restore</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/casskop/docs/7_troubleshooting/2_gke_issues"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">GKE Issues Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#operator-cant-perform-the-action" class="table-of-contents__link">Operator can&#39;t perform the Action</a><ul><li><a href="#cant-scaleup" class="table-of-contents__link">Can&#39;t ScaleUp</a></li><li><a href="#cant-add-new-rack-in-new-dc" class="table-of-contents__link">Can&#39;t add new rack in new DC</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Getting Started</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/casskop/docs/1_concepts/1_introduction">Documentation</a></li><li class="footer__item"><a href="https://github.com/Orange-OpenSource/casskop" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://casskop.slack.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a class="footer__link-item" href="/casskop/blog">Blog</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Contact</h4><ul class="footer__items"><li class="footer__item"><a href="mailto:prj.casskop.support@list.orangeportails.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email</a></li><li class="footer__item"><a href="https://github.com/Orange-OpenSource/casskop/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Feature request</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 Orange, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/casskop/styles.e109d7ba.js"></script>
<script src="/casskop/runtime~main.8734032c.js"></script>
<script src="/casskop/main.13402a17.js"></script>
<script src="/casskop/1.609d1f21.js"></script>
<script src="/casskop/2.9fbf0449.js"></script>
<script src="/casskop/67.98ba5add.js"></script>
<script src="/casskop/70.177fd3ba.js"></script>
<script src="/casskop/935f2afb.fcfa68e0.js"></script>
<script src="/casskop/17896441.6be1b574.js"></script>
<script src="/casskop/ac494530.39ec1365.js"></script>
</body>
</html>