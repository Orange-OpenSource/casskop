<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">


<title data-react-helmet="true">Blog | Casskop</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Blog | Casskop"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary">

<link data-react-helmet="true" rel="shortcut icon" href="/casskop/img/casskop.ico">


<link rel="stylesheet" href="/casskop/styles.fd86d1d7.css">


<link rel="preload" href="/casskop/styles.96fb9c2f.js" as="script">

<link rel="preload" href="/casskop/runtime~main.a08cd3cf.js" as="script">

<link rel="preload" href="/casskop/main.048f9187.js" as="script">

<link rel="preload" href="/casskop/1.6b5a90ca.js" as="script">

<link rel="preload" href="/casskop/2.e9ab7e35.js" as="script">

<link rel="preload" href="/casskop/3.0262e3d0.js" as="script">

<link rel="preload" href="/casskop/a6aa9e1f.4108a2ed.js" as="script">

<link rel="preload" href="/casskop/902ac59e.fc8285c6.js" as="script">

<link rel="preload" href="/casskop/4f62016a.5a277073.js" as="script">

<link rel="preload" href="/casskop/19d5c1fe.d1a48acf.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}function e(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}var n=window.matchMedia("(prefers-color-scheme: dark)");n.addListener((function(n){null===e()&&t(n.matches?"dark":"")}));var a=e();null!==a?t(a):n.matches&&t("dark")}()</script>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}function e(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}var n=window.matchMedia("(prefers-color-scheme: dark)");n.addListener((function(n){null===e()&&t(n.matches?"dark":"")}));var a=e();null!==a?t(a):n.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/casskop/"><img class="navbar__logo" src="/casskop/img/casskop_alone.png" alt="Casskop Logo"><strong>Casskop</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/casskop/docs/1_concepts/1_introduction">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/casskop/blog">Blog</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/Orange-OpenSource/casskop">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/casskop/"><img class="navbar__logo" src="/casskop/img/casskop_alone.png" alt="Casskop Logo"><strong>Casskop</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/1_concepts/1_introduction">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/casskop/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/Orange-OpenSource/casskop">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--xl"><div class="row"><div class="col col--8 col--offset-2"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_2RZH"><a href="/casskop/blog/dynamics_sidecars_storage">Casskop 0.5.1 - Dynamic sidecars and storage configuration feature</a></h2><div class="margin-bottom--sm"><time datetime="2020-03-26T00:00:00.000Z" class="blogPostDate_3tRe">March 26, 2020</time></div><div class="avatar margin-bottom--md"><a class="avatar__photo-link" href="https://github.com/erdrix" target="_blank" rel="noreferrer noopener"><img class="avatar__photo" src="https://avatars0.githubusercontent.com/u/10503351?s=460&amp;u=ea08d802388c79c17655c314296be58814391572&amp;v=4" alt="Alexandre Guitton"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/erdrix" target="_blank" rel="noreferrer noopener">Alexandre Guitton</a></h4><small class="avatar__subtitle">Alexandre Guitton</small></div></div></header><section class="markdown"><p>In a previous post, I was talking about how <a href="/casskop/blog/multicasskop_gke">Setting up Cassandra Multi-Site on Google Kubernetes Engine with Casskop</a>.
Since then, two new versions <a href="https://github.com/Orange-OpenSource/casskop/releases/tag/v0.5.1-release">0.5.1</a> and <a href="https://github.com/Orange-OpenSource/casskop/releases/tag/v0.5.2-release">0.5.2</a> had been released.
In another post, Cyril Scetbon focused on the <a href="https://medium.com/@cscetbon/new-probes-in-casskop-0-5-1-bfd1d6547967">New Probes feature</a> which was added with the [PR #184Ø(<a href="https://github.com/Orange-OpenSource/casskop/pull/184">https://github.com/Orange-OpenSource/casskop/pull/184</a>), in this post I will focus on the dynamic sidecars and storage configurations added to the operator, which give more flexibility to users to configure their Cassandra cluster deployments.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="purposes"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#purposes" title="Direct link to heading">#</a>Purposes</h2><p>During our production migration from bare metal Cassandra Cluster to Kubernetes, the main challenge was to perform the smoothest transition for our OPS teams, allowing them to reuse their homemade tools, to facilitate the cluster operationalization.
However, the operator in this previous form did not leave much room for tuning statefulset and therefore the Cassandra Cluster deployed.
You could use the bootstrap image to customize your cassandra node configuration, but not for the tools revolving around.
That is why we added to the <strong>CassandraCluster</strong> the possibility to define containers into the pod in addition to the cassandra ones, these are the <strong>sidecars</strong>, and to configure extract storage for the pods (ie <strong>VolumeClaimTemplates</strong> to the Statefulset configuration).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="dynamics-sidecars-configurations"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#dynamics-sidecars-configurations" title="Direct link to heading">#</a>Dynamics sidecars configurations</h2><p>To keep the <a href="https://cloud.google.com/blog/products/gcp/7-best-practices-for-building-containers">container’s best practices</a> and address our OPS needs, we added the ability to define a dynamic list of containers into a <strong>CassandraCluster.Spec</strong> resource definition: <a href="https://github.com/Orange-OpenSource/casskop/blob/master/pkg/apis/db/v1alpha1/cassandracluster_types.go#L803">cassandracluster_types.go#L803</a>.</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-yaml codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">sidecarConfigs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;tail&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-F&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/var/log/cassandra/system.log&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ez123/alpine</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tini</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Always</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cassandra</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">log</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 50m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 50Mi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10Mi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /var/log/cassandra</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cassandra</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">logs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;tail&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-F&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/var/log/cassandra/gc.log.0.current&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ez123/alpine</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tini</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Always</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">log</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 50m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 50Mi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10Mi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /var/log/cassandra</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">logs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span></div></code></pre></div><p>These sidecars are classic <a href="https://godoc.org/k8s.io/api/core/v1#Container">kubernetes container resources</a>, leaving you the full power on what you want to do.
With this example, we add two simple sidecars allowing to distinguish cassandra and GC logs in two different stdout.</p><div class="admonition admonition-note"><div class="admonition-heading"><h5><div class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div>note</h5></div><div class="admonition-content"><p>with this feature you can do everything you want, and obviously some bad things. This feature is not here to make a Cassandra Cluster works, the operator has everything for this, but to allow you to simplify some add-ons usage around Cassandra.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="sidecars--environment-variables"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#sidecars--environment-variables" title="Direct link to heading">#</a>Sidecars : environment variables</h2><p>All sidecars added with this configuration will have, at the container init, some of the environment variables from <strong>cassandra container</strong> merged with those defined into the sidecar container</p><ul><li>CASSANDRA_MAX_HEAP</li><li>CASSANDRA_SEEDS</li><li>CASSANDRA_CLUSTER_NAME</li><li>CASSANDRA_GC_STDOUT</li><li>CASSANDRA_NUM_TOKENS</li><li>CASSANDRA_DC</li><li>CASSANDRA_RACK</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="storage-configuration"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#storage-configuration" title="Direct link to heading">#</a>Storage configuration</h2><p>In the previous version, the only option about storage was the <a href="/casskop/docs/3_tasks/2_configuration_deployment/3_storage">data volume configuration</a> allowing you to define :</p><ul><li><code>dataCapacity</code>: Defines the size of the persistent volume claim, for example, &quot;1000Gi&quot;.</li><li><code>dataStorageClass</code>: Defines the type of storage to use (or use default one). We recommend to use local-storage for better performances but it can be any storage with high ssd throughput.</li></ul><p>The dynamic sidecar doesn’t really suit, unless you put everything in one folder.</p><div class="admonition admonition-warning"><div class="admonition-heading"><h5><div class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></div>Spoiler alert</h5></div><div class="admonition-content"><p>It’s not a good idea</p></div></div><p>That is why we add the <code>CassandraCluster.Spec.StorageConfig</code> field, to the <code>CassandraCluster</code> resource definition :</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-yaml codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token key atrule">storageConfigs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/var/lib/cassandra/log&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;gc-logs&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token key atrule">pvcSpec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token key atrule">accessModes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ReadWriteOnce</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token key atrule">storageClassName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> local</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">storage</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         </span><span class="token key atrule">requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 5Gi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/var/log/cassandra&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cassandra-logs&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token key atrule">pvcSpec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token key atrule">accessModes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ReadWriteOnce</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token key atrule">storageClassName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> local</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">storage</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           </span><span class="token key atrule">requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">             </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10Gi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span></div></code></pre></div><p><code>storageConfigs</code> : Defines the list of storage config object, which will instantiate <code>Persitence Volume Claim</code> and associate volume to pod of cassandra node.</p><ul><li><code>mountPath</code>: Defines the path into cassandra container where the volume will be mounted.</li><li><code>name</code>: Used to define the PVC and VolumeMount names.</li><li><code>pvcSpec</code>: pvcSpec describes the PVC used for the mountPath described above, it requires a kubernetes PVC spec.</li></ul><p>In this example, we add the two volumes required by our sidecars previously configured, to be able via the sidecars to access to the logs that we want to expose on the stdout.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="volume-claim-template-and-statefulset"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#volume-claim-template-and-statefulset" title="Direct link to heading">#</a>Volume Claim Template and statefulset</h2><p>Keep in mind that Casskop operator works on Statefulset, but have some constraints such as :</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-log codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">updates to statefulset spec for fields other than &#x27;replicas&#x27;, &#x27;template&#x27;, and &#x27;updateStrategy&#x27; are forbidden.</span></div></code></pre></div><p>So if you want to add or remove some storages configurations, today you have to perform manually it, by removing the Statefulset, which will be recreated by the operator.</p><div class="admonition admonition-note"><div class="admonition-heading"><h5><div class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div>note</h5></div><div class="admonition-content"><p>It’s not a sake operation, and should be performed carefully, because you will loose a rack. Maybe in some releases we will manage it, but today we assume that this operation is an exceptional one.</p></div></div><p><a href="https://github.com/Orange-OpenSource/casskop">CassKop</a> is open source so don’t hesitate to try it out, contribute by first trying to fix a discovered issue and let’s enhance it together!</p><p>In a next post, I will speak about the IP management into Casskop, and the <a href="https://github.com/Orange-OpenSource/casskop/issues/170">cross IPs issue</a>, so stay connected !</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/casskop/blog/tags/casskop">casskop</a><a class="margin-horiz--sm" href="/casskop/blog/tags/cassandra">cassandra</a><a class="margin-horiz--sm" href="/casskop/blog/tags/0-5-2">0.5.2</a><a class="margin-horiz--sm" href="/casskop/blog/tags/sidecars">sidecars</a><a class="margin-horiz--sm" href="/casskop/blog/tags/storage">storage</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_2RZH"><a href="/casskop/blog/multicasskop_gke">Multi-Casskop on Google Kubernetes Engine</a></h2><div class="margin-bottom--sm"><time datetime="2020-01-15T00:00:00.000Z" class="blogPostDate_3tRe">January 15, 2020</time></div><div class="avatar margin-bottom--md"><a class="avatar__photo-link" href="https://github.com/erdrix" target="_blank" rel="noreferrer noopener"><img class="avatar__photo" src="https://avatars0.githubusercontent.com/u/10503351?s=460&amp;u=ea08d802388c79c17655c314296be58814391572&amp;v=4" alt="Alexandre Guitton"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/erdrix" target="_blank" rel="noreferrer noopener">Alexandre Guitton</a></h4><small class="avatar__subtitle">Alexandre Guitton</small></div></div></header><section class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="pre-requisites"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pre-requisites" title="Direct link to heading">#</a>Pre-requisites</h2><p>User should need :</p><ul><li><a href="https://learn.hashicorp.com/terraform/getting-started/install.html">terraform</a> version v0.12.7+</li><li><a href="https://kubernetes.io/fr/docs/tasks/tools/install-kubectl">kubectl</a> version v1.13.3+</li><li><a href="https://github.com/ahmetb/kubectx">kubectx</a> &amp; kubens</li><li><a href="https://helm.sh/docs/intro/using_helm/">Helm</a> version v2.15.1+</li><li><a href="https://cloud.google.com/sdk/install?hl=fr">gcloud sdk</a> version 272.0.0+</li><li>A service account with enough rights (for this example : <code>editor</code>)</li><li>Having a DNS zone in google cloud dns.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="setup-gcp-environment"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#setup-gcp-environment" title="Direct link to heading">#</a>Setup GCP environment</h2><p>To setup the GCP environment we will use terraform provisionning, to instantiate the following infrastructure :</p><ul><li>2 GKE clusters :<ul><li>First on europe-west1-b which will be the <code>master</code></li><li>Second on europe-west1-c which will be the <code>slave</code></li></ul></li><li>Firewall rules to allow clusters to communicate</li><li>External DNS on each cluster to expose cassandra nodes</li><li>Casskop operator on each cluster to focus on multi-casskop usage</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="environment-setup"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#environment-setup" title="Direct link to heading">#</a>Environment setup</h3><p>Start to set variables needed for the instantiation : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export CASSKOP_WORKSPACE=&lt;path to cassandra-k8s-operateur project&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export PROJECT=&lt;gcp project&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export SERVICE_ACCOUNT_KEY_PATH=&lt;path to service account key&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export NAMESPACE=cassandra-demo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export DNS_ZONE_NAME=external-dns-test-gcp-trycatchlearn-fr     # -&gt; change with your own one</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export DNS_NAME=external-dns-test.gcp.trycatchlearn.fr          # -&gt; change with your own one</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export MANAGED_ZONE=tracking-pdb                                # -&gt; change with your own one</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="setup-base-infrastructure"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#setup-base-infrastructure" title="Direct link to heading">#</a>Setup base infrastructure</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ cd ${CASSKOP_WORKSPACE}/multi-casskop/samples/gke/terraform</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform init</span></div></code></pre></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="master-provisionning"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#master-provisionning" title="Direct link to heading">#</a>Master provisionning</h4><p><img src="/casskop/img/blog/2020-01-15-multicasskop_gke/multicasskop_architecture.jpeg" alt="MultiCasskop architecture"></p><p>With the master provisionning, we will deploy firewall and Cloud dns configuration :</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform workspace new master</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform workspace select master</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform apply \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var-file=&quot;env/master.tfvars&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;service_account_json_file=${SERVICE_ACCOUNT_KEY_PATH}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;namespace=${NAMESPACE}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;project=${PROJECT}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;dns_zone_name=${DNS_ZONE_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;dns_name=${DNS_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;managed_zone=${MANAGED_ZONE}&quot;</span></div></code></pre></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="slave-provisionning"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#slave-provisionning" title="Direct link to heading">#</a>Slave provisionning</h4><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform workspace new slave</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform workspace select slave</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform apply \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var-file=&quot;env/slave.tfvars&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;service_account_json_file=${SERVICE_ACCOUNT_KEY_PATH}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;namespace=${NAMESPACE}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;project=${PROJECT}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;dns_zone_name=${DNS_ZONE_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;dns_name=${DNS_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;managed_zone=${MANAGED_ZONE}&quot;</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="check-installation"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-installation" title="Direct link to heading">#</a>Check installation</h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="check-master-configuration"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-master-configuration" title="Direct link to heading">#</a>Check master configuration</h4><p>Now we will check that everything is well deployed in the GKE master cluster : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gcloud container clusters get-credentials cassandra-europe-west1-b-master --zone europe-west1-b --project ${PROJECT}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get pods -n ${NAMESPACE}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                                          READY   STATUS    RESTARTS   AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">casskop-cassandra-operator-54c4cfcbcb-b4qxq   1/1     Running   0          4h9m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">external-dns-6dd96c985-h76gh                  1/1     Running   0          4h16m</span></div></code></pre></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="check-slave-configuration"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-slave-configuration" title="Direct link to heading">#</a>Check slave configuration</h4><p>Now we will check that everything is well deployed in the GKE slave cluster : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gcloud container clusters get-credentials cassandra-europe-west1-c-slave --zone europe-west1-c --project ${PROJECT}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get pods -n ${NAMESPACE}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                                          READY   STATUS    RESTARTS   AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">casskop-cassandra-operator-54c4cfcbcb-sxjz7   1/1     Running   0          4m56s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">external-dns-7f947c5b5b-mq7kg                 1/1     Running   0          5m46s</span></div></code></pre></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="check-dns-zone-configuration"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-dns-zone-configuration" title="Direct link to heading">#</a>Check DNS zone configuration</h4><p>Make a note of the nameservers that were assigned to your new zone : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gcloud dns record-sets list \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --zone &quot;${DNS_ZONE_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --name &quot;${DNS_NAME}.&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --type NS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                                     TYPE  TTL    DATA</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">external-dns-test.gcp.trycatchlearn.fr.  NS    21600  ns-cloud-e1.googledomains.com.,ns-cloud-e2.googledomains.com.,ns-cloud-e3.googledomains.com.,ns-cloud-e4.googledomains.com.</span></div></code></pre></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="check-firewall-configuration"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-firewall-configuration" title="Direct link to heading">#</a>Check Firewall configuration</h4><p>@TODO : rework firewall source</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gcloud compute firewall-rules describe gke-cassandra-cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">allowed:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- IPProtocol: udp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- IPProtocol: tcp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">creationTimestamp: &#x27;2019-12-05T13:31:01.233-08:00&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">description: &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">direction: INGRESS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">disabled: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">id: &#x27;8270840333953452538&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: compute#firewall</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">logConfig:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  enable: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">name: gke-cassandra-cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">network: https://www.googleapis.com/compute/v1/projects/poc-rtc/global/networks/default</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">priority: 1000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">selfLink: https://www.googleapis.com/compute/v1/projects/poc-rtc/global/firewalls/gke-cassandra-cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sourceRanges:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- 0.0.0.0/0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">targetTags:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- cassandra-cluster</span></div></code></pre></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="check-storage-class"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-storage-class" title="Direct link to heading">#</a>Check Storage Class</h4><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get storageclasses.storage.k8s.io </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                 PROVISIONER            AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">standard (default)   kubernetes.io/gce-pd   28m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">standard-wait        kubernetes.io/gce-pd   24m</span></div></code></pre></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="multi-casskop-deployment"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#multi-casskop-deployment" title="Direct link to heading">#</a>Multi casskop deployment</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="bootstrap-api-access-to-slave-from-master"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#bootstrap-api-access-to-slave-from-master" title="Direct link to heading">#</a>Bootstrap API access to Slave from Master</h3><p>Multi-Casskop will be deployed in <code>master cluster</code>, change your <code>kubectl</code> context to point this cluster.</p><p>In order to allow Multi-CassKop controller to have access to <code>slave</code> from <code>master</code>, we are going to use <a href="https://github.com/admiraltyio/multicluster-service-account/releases/tag/v0.6.1">kubemcsa</a> from <a href="https://admiralty.io/">admiralty</a> to be able to export secret from <code>slave</code> to <code>master</code>.</p><p>Install <code>kubemcsa</code> : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ export RELEASE_VERSION=v0.6.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ wget https://github.com/admiraltyio/multicluster-service-account/releases/download/${RELEASE_VERSION}/kubemcsa-linux-amd64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ mkdir -p ~/tools/kubemcsa/${RELEASE_VERSION} &amp;&amp; mv kubemcsa-linux-amd64 tools/kubemcsa/${RELEASE_VERSION}/kubemcsa</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ chmod +x ~/tools/kubemcsa/${RELEASE_VERSION}/kubemcsa</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ sudo ln -sfn  ~/tools/kubemcsa/${RELEASE_VERSION}/kubemcsa /usr/local/bin/kubemcsa</span></div></code></pre></div><p>Generate secret for <code>master</code> : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectx # Switch context on master cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Switched to context &quot;gke_&lt;Project name&gt;_europe-west1-b_cassandra-europe-west1-b-master&quot;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubens # Switch context on correct namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Context &quot;gke_&lt;Project name&gt;_europe-west1-b_cassandra-europe-west1-b-master&quot; modified.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Active namespace is &quot;&lt;Namespace&gt;&quot;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubemcsa export --context=gke_poc-rtc_europe-west1-c_cassandra-europe-west1-c-slave --namespace ${NAMESPACE} cassandra-operator --as gke-slave-west1-c | kubectl apply -f -</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">secret/gke-slave-west1-c created</span></div></code></pre></div><p>Check that the secret is correctly created</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get secrets -n ${NAMESPACE}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gke-slave-west1-c                Opaque                                5      28s</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="install-multi-casskop"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#install-multi-casskop" title="Direct link to heading">#</a>Install Multi-CassKop</h3><p>@TODO : To correct once the watch object will be fixed</p><p>Add MultiCasskop crd on the <code>slave</code> cluster : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectx # Switch context on slave cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Switched to context &quot;gke_&lt;Project name&gt;_europe-west1-c_cassandra-europe-west1-c-slave&quot;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f https://raw.githubusercontent.com/Orange-OpenSource/casskop/master/multi-casskop/deploy/crds/multicluster_v1alpha1_cassandramulticluster_crd.yaml</span></div></code></pre></div><p>Deployment with Helm : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectx # Switch context on master cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Switched to context &quot;gke_&lt;Project name&gt;_europe-west1-b_cassandra-europe-west1-b-master&quot;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ helm init --client-only</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ helm repo add orange-incubator https://orange-kubernetes-charts-incubator.storage.googleapis.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ helm repo update</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ cd ${CASSKOP_WORKSPACE}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ helm install --name multi-casskop orange-incubator/multi-casskop --set k8s.local=gke-master-west1-b --set k8s.remote={gke-slave-west1-c} #--no-hooks if crd already install</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="create-the-multicasskop-crd"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#create-the-multicasskop-crd" title="Direct link to heading">#</a>Create the MultiCasskop CRD</h3><p>Now we are ready to deploy a MultiCassKop CRD instance.
We will use the example in <code>multi-casskop/samples/gke/multi-casskop-gke.yaml</code> :</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f multi-casskop/samples/gke/multi-casskop-gke.yaml</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="check-multi-cluster-installation"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-multi-cluster-installation" title="Direct link to heading">#</a>Check multi cluster installation</h3><p>We can see that each cluster has the required pods : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectx # Switch context on master cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Switched to context &quot;gke_&lt;Project name&gt;_europe-west1-b_cassandra-europe-west1-b-master&quot;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get pods -n ${NAMESPACE}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                                          READY   STATUS    RESTARTS   AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc1-rack1-0                    1/1     Running   0          8m30s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">casskop-cassandra-operator-54c4cfcbcb-8qncr   1/1     Running   0          34m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">external-dns-6dd96c985-7jf6w                  1/1     Running   0          35m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">multi-casskop-67dc74dff7-z4642                1/1     Running   0          11m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectx # Switch context on slave cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Switched to context &quot;gke_&lt;Project name&gt;_europe-west1-c_cassandra-europe-west1-c-slave&quot;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get pods -n ${NAMESPACE}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                                          READY   STATUS    RESTARTS   AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc3-rack3-0                    1/1     Running   0          6m55s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc4-rack4-0                    1/1     Running   0          4m59s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandra-demo-dc4-rack4-1                    1/1     Running   0          3m20s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">casskop-cassandra-operator-54c4cfcbcb-sxjz7   1/1     Running   0          71m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">external-dns-7f947c5b5b-mq7kg                 1/1     Running   0          72m</span></div></code></pre></div><p>If we go in one of the created pods, we can see that nodetool see pods of both clusters : </p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectx # Switch context on master cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Switched to context &quot;gke_&lt;Project name&gt;_europe-west1-b_cassandra-europe-west1-b-master&quot;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl exec -ti cassandra-demo-dc1-rack1-0 nodetool status</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Datacenter: dc1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">===============</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Status=Up/Down</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|/ State=Normal/Leaving/Joining/Moving</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--  Address    Load       Tokens       Owns (effective)  Host ID                               Rack</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">UN  10.52.2.3  108.62 KiB  256          49.2%             a0958905-e1fa-4410-baca-fc86f4457f1a  rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Datacenter: dc3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">===============</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Status=Up/Down</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|/ State=Normal/Leaving/Joining/Moving</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--  Address    Load       Tokens       Owns (effective)  Host ID                               Rack</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">UN  10.8.3.2   74.95 KiB  256          51.5%             03f8eede-4b69-43be-a0c1-73f73470398b  rack3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Datacenter: dc4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">===============</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Status=Up/Down</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|/ State=Normal/Leaving/Joining/Moving</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--  Address    Load       Tokens       Owns (effective)  Host ID                               Rack</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">UN  10.8.4.3   107.87 KiB  256          47.8%             1a7432e2-4ca8-4767-acdb-3b40e6ff4a57  rack4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">UN  10.8.2.5   107.85 KiB  256          51.6%             272037ce-4146-42c1-9079-ef4561249254  rack4</span></div></code></pre></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="clean-up-everything"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#clean-up-everything" title="Direct link to heading">#</a>Clean up everything</h2><p>If you have set the <code>deleteCassandraCluster</code> to true, then when deleting the <code>MultiCassKop</code> object, it will cascade the deletion of the CassandraCluster object in the targeted k8s clusters. Then each local CassKop will delete their Cassandra clusters (else skip this step)</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl delete multicasskops.db.orange.com multi-casskop-demo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ helm del --purge multi-casskop</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="cleaning-slave-cluster"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#cleaning-slave-cluster" title="Direct link to heading">#</a>Cleaning slave cluster</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ cd ${CASSKOP_WORKSPACE}/multi-casskop/samples/gke/terraform</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform workspace select slave</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform destroy \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var-file=&quot;env/slave.tfvars&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;service_account_json_file=${SERVICE_ACCOUNT_KEY_PATH}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;namespace=${NAMESPACE}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;project=${PROJECT}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;dns_zone_name=${DNS_ZONE_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;dns_name=${DNS_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;managed_zone=${MANAGED_ZONE}&quot;</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="cleaning-master-cluster"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#cleaning-master-cluster" title="Direct link to heading">#</a>Cleaning master cluster</h3><p>Before running the following command, you need to clean dns records set.</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-sh codeBlock_2GNs"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button><code class="codeBlockLines__q0i" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform workspace select master</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ terraform destroy \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var-file=&quot;env/master.tfvars&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;service_account_json_file=${SERVICE_ACCOUNT_KEY_PATH}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;namespace=${NAMESPACE}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;project=${PROJECT}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;dns_zone_name=${DNS_ZONE_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;dns_name=${DNS_NAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -var=&quot;managed_zone=${MANAGED_ZONE}&quot;</span></div></code></pre></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/casskop/blog/tags/gke">gke</a><a class="margin-horiz--sm" href="/casskop/blog/tags/casskop">casskop</a><a class="margin-horiz--sm" href="/casskop/blog/tags/cassandra">cassandra</a><a class="margin-horiz--sm" href="/casskop/blog/tags/external-dns">external-dns</a><a class="margin-horiz--sm" href="/casskop/blog/tags/multi-casskop">multi-casskop</a></div></footer></article><nav class="pagination-nav"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Getting Started</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/casskop/docs/1_concepts/1_introduction">Documentation</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/Orange-OpenSource/casskop">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://casskop.slack.com">Slack</a></li><li class="footer__item"><a aria-current="page" class="footer__link-item active" href="/casskop/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://twitter.com">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Contact</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="mailto:prj.casskop.support@list.orangeportails.net">Email</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/Orange-OpenSource/casskop/issues">Feature request</a></li></ul></div></div><div class="text--center">Copyright © 2020 Orange, Inc. Built with Docusaurus.</div></div></footer>
</div>

<script src="/casskop/styles.96fb9c2f.js"></script>

<script src="/casskop/runtime~main.a08cd3cf.js"></script>

<script src="/casskop/main.048f9187.js"></script>

<script src="/casskop/1.6b5a90ca.js"></script>

<script src="/casskop/2.e9ab7e35.js"></script>

<script src="/casskop/3.0262e3d0.js"></script>

<script src="/casskop/a6aa9e1f.4108a2ed.js"></script>

<script src="/casskop/902ac59e.fc8285c6.js"></script>

<script src="/casskop/4f62016a.5a277073.js"></script>

<script src="/casskop/19d5c1fe.d1a48acf.js"></script>


</body>
</html>